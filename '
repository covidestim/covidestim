validate_input <- function(d, type) {

  pvec <- purrr::partial(paste, ...=, collapse = ', ')

  att(
    is.data.frame(d),
    msg=glue("Input must be a `data.frame`. Your input was a {pvec(class(d))}")
  )
  att(
    nrow(d) >= 1,
    msg="The input data.frame had 0 rows"
  )
  att(
    setequal(names(d), c("date", "observation")),
    msg=glue("The only variables in the data.frame should be 'date' and 'observation'. ",
             "Yours were: `{vars}`", vars = pvec(names(d)))
  )
  att(
    "POSIXct" %in% class(d$date) | "Date" %in% class(d$date),
    msg=glue("The `date` variable must be of class `POSIXct` or `Date`. ",
             "Your `date` variable was of class `{pvec(class(d$date))}`. ",
             "Consider using as.Date()?")
  )
  att(
    is.numeric(d$observation),
    msg=glue(
      "The `observation` variable must be a numeric vector. ",
      "Your `observation` variable was of type ",
      "`{pvec(class(d$observation))}`"
    )
  )
  att(
    all(d$observation >= 0),
    msg=glue("At least one observation was < 0. ",
             "This occurred on rows {pvec(which(d$observation < 0))}")
  )
  att(
    assertthat::is.string(type),
    msg = "Type of input data must be passed as a string."
  )
  att(
    type %in% c("reported", "occurred"),
    msg = glue("`type` of input data must be one of 'reported', 'occurred'. ",
               "You passed {type}.")
  )
}

validate_fracpos <- function(d) {

  pvec <- purrr::partial(paste, ...=, collapse = ', ')

  att(
    is.data.frame(d),
    msg=glue("Input must be a `data.frame`. Your input was a {pvec(class(d))}")
  )
  att(
    nrow(d) >= 1,
    msg="The input data.frame had 0 rows"
  )
  att(
    setequal(names(d), c("date", "observation")),
    msg=glue("The only variables in the data.frame should be 'date' and 'observation'. ",
             "Yours were: `{vars}`", vars = pvec(names(d)))
  )
  att(
    "POSIXct" %in% class(d$date) | "Date" %in% class(d$date),
    msg=glue("The `date` variable must be of class `POSIXct` or `Date`. ",
             "Your `date` variable was of class `{pvec(class(d$date))}`. ",
             "Consider using as.Date()?")
  )
  att(
    is.numeric(d$observation),
    msg=glue(
      "The `observation` variable must be a numeric vector. ",
      "Your `observation` variable was of type ",
      "`{pvec(class(d$observation))}`"
    )
  )
  att(
    all(d$observation >= 0),
    msg=glue("At least one observation was < 0. ",
             "This occurred on rows {pvec(which(d$observation < 0))}")
  )
  att(
    all(d$observation <= 1),
    msg=glue("At least one observation was > 1. ",
             "This occurred on rows {pvec(which(d$observation > 1))}")
  )
}

transform_input <- function(d)
  dplyr::mutate(
    d,
    date        = reformat_dates(date),
    observation = as.integer(observation)
  )

transform_fracpos <- function(d)
  dplyr::mutate(
    d,
    date        = reformat_dates(date),
    observation = observation
  )

reformat_dates <- function(vec) vec

#' Input observational data
#'
#' There are three types of observational data that can be used with Covidcast.
#'
#' \itemize{
#'   \item Case reporting data, detailing the number of new cases each day
#'   \item Death data, detailing the number of confirmed Covid-19 deaths each
#'   day
#'   \item Testing data, detailing the fraction of positive tests for each day
#'   of data. 
#' }
#'
#' All input data to Covidcast is expected to be a
#' \code{\link[base]{data.frame}} of two variables. One variable, \code{date}
#' must be a vector of type \code{\link[base]{POSIXct}} or
#' \code{\link[base]{Date}}. The second column, \code{observations} will be a
#' non-negative numeric vector, except in the case of testing data, where the
#' column must be a numeric vector between \code{[0,1]}.
#'
#' Fraction positve data should represent, for a given day, the fraction of
#' positive test results reported that day, over the total number of test
#' results received that day. Note that the model tends to perform poorly on
#' fraction positive data that contains dramatic jumps. With jumpy data, it 
#' is recommended to smooth the fraction positive data with a moving average,
#' for examplg by using the function \code{link[smooth]{sma}}. Reasons for
#' these jumps, as seen in publicly available datasets, have included:
#'
#' \itemize{
#'   \item Dumping of test results: Some states have a tendency to dump batches
#'     of results on particular days. Sometimes, these batches are composed of
#'     only positive results, or only negative results, but other times it is
#'     a mix.
#'
#'   \item Accumulation of test results reported over the weekend: Many states
#'     have lower reporting volume over the weekend, creating an unstable
#'     fraction positive quantity as the sample size increases and decreases
#'     dramatically.
#'
#'   \item Reclassification of results: Some states have retroactively changed
#'     test results, or removed test results entirely, and these changes may 
#'     manifest all on a single day, rather than being applied to all previous
#'     days affected by the change.
#'
#'   \item Antibody tests: Some states have been pooling antibody tests with
#'     viral tests, as reported in \href{https://www.theatlantic.com/health/archive/2020/05/cdc-and-states-are-misreporting-covid-19-test-data-pennsylvania-georgia-texas/611935/}{The Atlantic}, and are now
#'     removing that pooling from their data.
#' }
#'
#' Missing values in cases and deaths data should be represented as \code{0}.
#' The date range of all sets of data passed must be equivalent, with one
#' observation each day, and no gaps in the data. Assertions attempt to enforce
#' this specification.
#'
#' @param data A \code{\link[base]{data.frame}} as described below.
#' @param type A string, either \code{"reported"} or \code{"occurred"}.
#' 
#'   \code{"reported"} applies to the following situations:
#'   \itemize{
#'     \item Cases or deaths data where the count for a particular day
#'     represents the number of cases or deaths that were reported publicly on
#'     that day (for example, as of June 1st, 2020, this is the type of data
#'       reported by the New York Times'
#'        \href{https://github.com/nytimes/covid-19-data}{covid-19-data}
#'       repository, and by the
#'       \href{https://covidtracking.org}{Covid Tracking Project}.
#'     \item Cases or deaths data where the count for a particular day is the 
#'       number of cases or deaths received from hospital reports, or
#'       diagnostic laboratories, accumulated across a particular region
#'   }
#'
#'   \code{"occurred"} applies to the following situations:
#'   \itemize{
#'     \item Data where counts represent the number of times a particular event
#'       actually occured on that day. For case data, this would be the day a 
#'       test was administered, and for deaths data, this would be the day an
#'       individual died. Note that, if the deaths data represented the day an
#'       individual's death was first reported as a SARS-Cov-2-related death,
#'       that data should be passed with \code{type = "reported"}, instead.
#'   }
#'
#'
#' @export
input_cases <- function(data, type = "reported") {
  validate_input(data, type)
  data <- transform_input(data)
  structure(list(obs_cas=data), class='input', date_type = type)
}

#' @rdname input_cases
#' @export
input_deaths <- function(data, type = "reported") {
  validate_input(data, type)
  data <- transform_input(data)
  structure(list(obs_die=data), class='input', date_type = type)
}

#' @rdname input_cases
#' @export
input_fracpos <- function(data) {
  validate_fracpos(data)
  data <- transform_fracpos(data)
  structure(list(frac_pos=data), class='input', date_type = "reported")
}
